<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/talkify/auth/LoginActivity.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/talkify/auth/LoginActivity.java" />
              <option name="originalContent" value="package com.example.talkify.auth;&#10;&#10;import android.content.Intent;&#10;import android.os.Bundle;&#10;import android.util.Log;&#10;import android.widget.Button;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.activity.result.ActivityResultLauncher;&#10;import androidx.activity.result.contract.ActivityResultContracts;&#10;import androidx.annotation.NonNull;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;&#10;import com.example.talkify.BuildConfig;&#10;import com.example.talkify.MainActivity;&#10;import com.example.talkify.R;&#10;import com.example.talkify.services.SharedPrefManager;&#10;import com.example.talkify.services.SupabaseClient;&#10;import com.google.android.gms.auth.api.signin.*;&#10;import com.google.android.gms.common.api.ApiException;&#10;import com.google.android.gms.tasks.Task;&#10;import com.google.android.material.textfield.TextInputEditText;&#10;import com.google.gson.Gson;&#10;import com.google.gson.JsonArray;&#10;import com.google.gson.JsonObject;&#10;&#10;import java.io.IOException;&#10;&#10;import okhttp3.*;&#10;&#10;public class LoginActivity extends AppCompatActivity {&#10;&#10;    private static final String TAG = &quot;LoginActivity&quot;;&#10;&#10;    private TextInputEditText etEmail, etPassword;&#10;    private Button btnLogin, btnGoogle, btnFacebook;&#10;    private TextView tvRegister;&#10;&#10;    private SharedPrefManager prefManager;&#10;    private final OkHttpClient client = new OkHttpClient();&#10;    private final Gson gson = new Gson();&#10;    private static final MediaType JSON = MediaType.get(&quot;application/json; charset=utf-8&quot;);&#10;&#10;    // Google Sign-In&#10;    private GoogleSignInClient mGoogleSignInClient;&#10;    private static final String GOOGLE_ANDROID_CLIENT_ID = BuildConfig.GOOGLE_CLIENT_ID;&#10;&#10;    // (Lưu ý: Bạn phải thêm hàm saveUserSession vào SharedPrefManager)&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_login);&#10;&#10;        prefManager = SharedPrefManager.getInstance(this);&#10;&#10;        if (prefManager.isLoggedIn()) {&#10;            startActivity(new Intent(this, MainActivity.class));&#10;            finish();&#10;            return;&#10;        }&#10;&#10;        initViews();&#10;        setupListeners();&#10;        setupGoogleSignIn();&#10;    }&#10;&#10;    private void initViews() {&#10;        etEmail = findViewById(R.id.etEmail);&#10;        etPassword = findViewById(R.id.etPassword);&#10;        btnLogin = findViewById(R.id.btnLogin);&#10;        btnGoogle = findViewById(R.id.btnGoogle);&#10;        btnFacebook = findViewById(R.id.btnFacebook);&#10;        tvRegister = findViewById(R.id.tvRegister);&#10;    }&#10;&#10;    private void setupListeners() {&#10;        btnLogin.setOnClickListener(v -&gt; {&#10;            String email = etEmail.getText() != null ? etEmail.getText().toString().trim() : &quot;&quot;;&#10;            String password = etPassword.getText() != null ? etPassword.getText().toString().trim() : &quot;&quot;;&#10;&#10;            if (email.isEmpty() || password.isEmpty()) {&#10;                Toast.makeText(this, &quot;Vui lòng nhập email và mật khẩu.&quot;, Toast.LENGTH_SHORT).show();&#10;                return;&#10;            }&#10;&#10;            loginWithEmail(email, password);&#10;        });&#10;&#10;        btnGoogle.setOnClickListener(v -&gt; signInWithGoogle());&#10;        btnFacebook.setOnClickListener(v -&gt; Toast.makeText(this, &quot;Tính năng Facebook đang được phát triển.&quot;, Toast.LENGTH_SHORT).show());&#10;        tvRegister.setOnClickListener(v -&gt; startActivity(new Intent(this, RegisterActivity.class)));&#10;    }&#10;&#10;    private void setupGoogleSignIn() {&#10;        GoogleSignInOptions gso = new GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)&#10;                .requestIdToken(GOOGLE_ANDROID_CLIENT_ID)&#10;                .requestEmail()&#10;                .build();&#10;        mGoogleSignInClient = GoogleSignIn.getClient(this, gso);&#10;    }&#10;&#10;    private void signInWithGoogle() {&#10;        Intent signInIntent = mGoogleSignInClient.getSignInIntent();&#10;        googleSignInLauncher.launch(signInIntent);&#10;    }&#10;&#10;    private final ActivityResultLauncher&lt;Intent&gt; googleSignInLauncher =&#10;            registerForActivityResult(new ActivityResultContracts.StartActivityForResult(), result -&gt; {&#10;                if (result.getResultCode() == RESULT_OK) {&#10;                    Task&lt;GoogleSignInAccount&gt; task = GoogleSignIn.getSignedInAccountFromIntent(result.getData());&#10;                    handleSignInResult(task);&#10;                } else {&#10;                    Toast.makeText(LoginActivity.this, &quot;Đăng nhập Google thất bại hoặc bị hủy.&quot;, Toast.LENGTH_SHORT).show();&#10;                }&#10;            });&#10;&#10;    private void handleSignInResult(Task&lt;GoogleSignInAccount&gt; completedTask) {&#10;        try {&#10;            GoogleSignInAccount account = completedTask.getResult(ApiException.class);&#10;            String idToken = account.getIdToken();&#10;&#10;            if (idToken != null) {&#10;                signInWithSupabaseGoogle(idToken);&#10;            } else {&#10;                Toast.makeText(this, &quot;Không thể lấy Google ID Token.&quot;, Toast.LENGTH_SHORT).show();&#10;            }&#10;        } catch (ApiException e) {&#10;            Log.e(TAG, &quot;Google Sign-In Error: &quot; + e.getMessage());&#10;            Toast.makeText(this, &quot;Đăng nhập Google thất bại: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;        }&#10;    }&#10;&#10;&#10;    /**&#10;     * BƯỚC 1 (GOOGLE): Lấy Token&#10;     */&#10;    private void signInWithSupabaseGoogle(String idToken) {&#10;        String url = SupabaseClient.URL + &quot;/auth/v1/token?grant_type=id_token&quot;;&#10;        JsonObject json = new JsonObject();&#10;        json.addProperty(&quot;provider&quot;, &quot;google&quot;);&#10;        json.addProperty(&quot;id_token&quot;, idToken);&#10;&#10;        RequestBody body = RequestBody.create(gson.toJson(json), JSON);&#10;&#10;        Request request = new Request.Builder()&#10;                .url(url)&#10;                .post(body)&#10;                .addHeader(&quot;apikey&quot;, SupabaseClient.ANON_KEY)&#10;                .addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)&#10;                .build();&#10;&#10;        client.newCall(request).enqueue(new Callback() {&#10;            @Override public void onFailure(@NonNull Call call, @NonNull IOException e) {&#10;                runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi mạng: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show());&#10;            }&#10;&#10;            @Override public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {&#10;                String resStr = response.body().string();&#10;                if (response.isSuccessful()) {&#10;                    JsonObject resJson = gson.fromJson(resStr, JsonObject.class);&#10;                    String accessToken = resJson.get(&quot;access_token&quot;).getAsString();&#10;                    String refreshToken = resJson.get(&quot;refresh_token&quot;).getAsString();&#10;                    JsonObject userObj = resJson.getAsJsonObject(&quot;user&quot;);&#10;                    String userId = userObj.get(&quot;id&quot;).getAsString();&#10;                    String email = userObj.get(&quot;email&quot;).getAsString();&#10;&#10;                    // === SỬA ĐỔI ===&#10;                    // (Không lưu và chuyển màn hình vội)&#10;                    // (Gọi Bước 2: Lấy hồ sơ)&#10;                    fetchUserProfileAndProceed(userId, email, accessToken, refreshToken);&#10;&#10;                } else {&#10;                    Log.e(TAG, &quot;Supabase Google login failed: &quot; + resStr);&#10;                    runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Đăng nhập Google thất bại.&quot;, Toast.LENGTH_LONG).show());&#10;                }&#10;            }&#10;        });&#10;    }&#10;&#10;    /**&#10;     * BƯỚC 1 (EMAIL): Lấy Token&#10;     */&#10;    private void loginWithEmail(String email, String password) {&#10;        String url = SupabaseClient.URL + &quot;/auth/v1/token?grant_type=password&quot;;&#10;        JsonObject json = new JsonObject();&#10;        json.addProperty(&quot;email&quot;, email);&#10;        json.addProperty(&quot;password&quot;, password);&#10;&#10;        RequestBody body = RequestBody.create(gson.toJson(json), JSON);&#10;&#10;        Request request = new Request.Builder()&#10;                .url(url)&#10;                .post(body)&#10;                .addHeader(&quot;apikey&quot;, SupabaseClient.ANON_KEY)&#10;                .addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)&#10;                .build();&#10;&#10;        client.newCall(request).enqueue(new Callback() {&#10;            @Override public void onFailure(@NonNull Call call, @NonNull IOException e) {&#10;                runOnUiThread(() -&gt;&#10;                        Toast.makeText(LoginActivity.this, &quot;Lỗi kết nối: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show());&#10;            }&#10;&#10;            @Override public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {&#10;                String resStr = response.body().string();&#10;                if (response.isSuccessful()) {&#10;                    JsonObject resJson = gson.fromJson(resStr, JsonObject.class);&#10;                    String accessToken = resJson.get(&quot;access_token&quot;).getAsString();&#10;                    String refreshToken = resJson.get(&quot;refresh_token&quot;).getAsString();&#10;                    JsonObject userObj = resJson.getAsJsonObject(&quot;user&quot;);&#10;                    String userId = userObj.get(&quot;id&quot;).getAsString();&#10;&#10;                    // === SỬA ĐỔI ===&#10;                    // (Không lưu và chuyển màn hình vội)&#10;                    // (Gọi Bước 2: Lấy hồ sơ)&#10;                    fetchUserProfileAndProceed(userId, email, accessToken, refreshToken);&#10;&#10;                } else {&#10;                    runOnUiThread(() -&gt;&#10;                            Toast.makeText(LoginActivity.this, &quot;Sai email hoặc mật khẩu.&quot;, Toast.LENGTH_LONG).show());&#10;                }&#10;            }&#10;        });&#10;    }&#10;&#10;    /**&#10;     * ==========================================================&#10;     * HÀM MỚI (BƯỚC 2 &amp; 3): Lấy Hồ sơ và Lưu Session&#10;     * ==========================================================&#10;     */&#10;    private void fetchUserProfileAndProceed(String userId, String email, String accessToken, String refeshToken) {&#10;        // (API call: GET /rest/v1/users?user_id=eq.{userId}&amp;select=*)&#10;        String url = SupabaseClient.URL + &quot;/rest/v1/users?user_id=eq.&quot; + userId + &quot;&amp;select=*&quot;;&#10;&#10;        Request request = new Request.Builder()&#10;                .url(url)&#10;                .get()&#10;                .addHeader(&quot;apikey&quot;, SupabaseClient.ANON_KEY)&#10;                .addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken) // Dùng token MỚI&#10;                .build();&#10;&#10;        client.newCall(request).enqueue(new Callback() {&#10;            @Override&#10;            public void onFailure(@NonNull Call call, @NonNull IOException e) {&#10;                runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi tải hồ sơ: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show());&#10;            }&#10;&#10;            @Override&#10;            public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {&#10;                String resStr = response.body().string();&#10;                if (response.isSuccessful()) {&#10;                    // Kết quả là một mảng JSON: &quot;[{...}]&quot;&#10;                    JsonArray jsonArray = gson.fromJson(resStr, JsonArray.class);&#10;&#10;                    if (jsonArray.size() &gt; 0) {&#10;                        // Lấy hồ sơ (profile) đầu tiên&#10;                        JsonObject userProfile = jsonArray.get(0).getAsJsonObject();&#10;&#10;                        String fullName = userProfile.get(&quot;full_name&quot;).getAsString();&#10;                        String avatarUrl = userProfile.get(&quot;avatar_url&quot;).getAsString();&#10;&#10;                        // BƯỚC 3: LƯU TẤT CẢ VÀO SESSION&#10;                        prefManager.saveUserSession(&#10;                                userId,&#10;                                email,&#10;                                accessToken,&#10;                                refeshToken,&#10;                                fullName,&#10;                                avatarUrl&#10;                        );&#10;&#10;                        // Bây giờ mới chuyển màn hình&#10;                        runOnUiThread(() -&gt; {&#10;                            Toast.makeText(LoginActivity.this, &quot;Đăng nhập thành công!&quot;, Toast.LENGTH_SHORT).show();&#10;                            startActivity(new Intent(LoginActivity.this, MainActivity.class));&#10;                            finish();&#10;                        });&#10;                    } else {&#10;                        // (Lỗi này xảy ra nếu Trigger (bước 1) bị lỗi:&#10;                        //  đã tạo user (auth) nhưng chưa tạo profile (database))&#10;                        runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi: Không tìm thấy hồ sơ người dùng.&quot;, Toast.LENGTH_SHORT).show());&#10;                    }&#10;                } else {&#10;                    // Lỗi (ví dụ: 401 do RLS, 404, ...)&#10;                    runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi tải hồ sơ: &quot; + resStr, Toast.LENGTH_LONG).show());&#10;                }&#10;            }&#10;        });&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.talkify.auth;&#10;&#10;import android.content.Intent;&#10;import android.os.Bundle;&#10;import android.util.Log;&#10;import android.widget.Button;&#10;import android.widget.TextView;&#10;import android.widget.Toast;&#10;&#10;import androidx.activity.result.ActivityResultLauncher;&#10;import androidx.activity.result.contract.ActivityResultContracts;&#10;import androidx.annotation.NonNull;&#10;import androidx.appcompat.app.AppCompatActivity;&#10;&#10;import com.example.talkify.BuildConfig;&#10;import com.example.talkify.MainActivity;&#10;import com.example.talkify.R;&#10;import com.example.talkify.services.SharedPrefManager;&#10;import com.example.talkify.services.SupabaseClient;&#10;import com.google.android.gms.auth.api.signin.*;&#10;import com.google.android.gms.common.api.ApiException;&#10;import com.google.android.gms.tasks.Task;&#10;import com.google.android.material.textfield.TextInputEditText;&#10;import com.google.gson.Gson;&#10;import com.google.gson.JsonArray;&#10;import com.google.gson.JsonObject;&#10;&#10;import java.io.IOException;&#10;&#10;import okhttp3.*;&#10;&#10;public class LoginActivity extends AppCompatActivity {&#10;&#10;    private static final String TAG = &quot;LoginActivity&quot;;&#10;&#10;    private TextInputEditText etEmail, etPassword;&#10;    private Button btnLogin, btnGoogle, btnFacebook;&#10;    private TextView tvRegister;&#10;&#10;    private SharedPrefManager prefManager;&#10;    private final OkHttpClient client = new OkHttpClient();&#10;    private final Gson gson = new Gson();&#10;    private static final MediaType JSON = MediaType.get(&quot;application/json; charset=utf-8&quot;);&#10;&#10;    // Google Sign-In&#10;    private GoogleSignInClient mGoogleSignInClient;&#10;    private static final String GOOGLE_ANDROID_CLIENT_ID = BuildConfig.GOOGLE_CLIENT_ID;&#10;&#10;    // (Lưu ý: Bạn phải thêm hàm saveUserSession vào SharedPrefManager)&#10;&#10;    @Override&#10;    protected void onCreate(Bundle savedInstanceState) {&#10;        super.onCreate(savedInstanceState);&#10;        setContentView(R.layout.activity_login);&#10;&#10;        prefManager = SharedPrefManager.getInstance(this);&#10;&#10;        if (prefManager.isLoggedIn()) {&#10;            startActivity(new Intent(this, MainActivity.class));&#10;            finish();&#10;            return;&#10;        }&#10;&#10;        initViews();&#10;        setupListeners();&#10;        setupGoogleSignIn();&#10;    }&#10;&#10;    private void initViews() {&#10;        etEmail = findViewById(R.id.etEmail);&#10;        etPassword = findViewById(R.id.etPassword);&#10;        btnLogin = findViewById(R.id.btnLogin);&#10;        btnGoogle = findViewById(R.id.btnGoogle);&#10;        btnFacebook = findViewById(R.id.btnFacebook);&#10;        tvRegister = findViewById(R.id.tvRegister);&#10;    }&#10;&#10;    private void setupListeners() {&#10;        btnLogin.setOnClickListener(v -&gt; {&#10;            String email = etEmail.getText() != null ? etEmail.getText().toString().trim() : &quot;&quot;;&#10;            String password = etPassword.getText() != null ? etPassword.getText().toString().trim() : &quot;&quot;;&#10;&#10;            if (email.isEmpty() || password.isEmpty()) {&#10;                Toast.makeText(this, &quot;Vui lòng nhập email và mật khẩu.&quot;, Toast.LENGTH_SHORT).show();&#10;                return;&#10;            }&#10;&#10;            loginWithEmail(email, password);&#10;        });&#10;&#10;        btnGoogle.setOnClickListener(v -&gt; signInWithGoogle());&#10;        btnFacebook.setOnClickListener(v -&gt; Toast.makeText(this, &quot;Tính năng Facebook đang được phát triển.&quot;, Toast.LENGTH_SHORT).show());&#10;        tvRegister.setOnClickListener(v -&gt; startActivity(new Intent(this, RegisterActivity.class)));&#10;    }&#10;&#10;    private void setupGoogleSignIn() {&#10;        GoogleSignInOptions gso = new GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)&#10;                .requestIdToken(GOOGLE_ANDROID_CLIENT_ID)&#10;                .requestEmail()&#10;                .build();&#10;        mGoogleSignInClient = GoogleSignIn.getClient(this, gso);&#10;    }&#10;&#10;    private void signInWithGoogle() {&#10;        Intent signInIntent = mGoogleSignInClient.getSignInIntent();&#10;        googleSignInLauncher.launch(signInIntent);&#10;    }&#10;&#10;    private final ActivityResultLauncher&lt;Intent&gt; googleSignInLauncher =&#10;            registerForActivityResult(new ActivityResultContracts.StartActivityForResult(), result -&gt; {&#10;                if (result.getResultCode() == RESULT_OK) {&#10;                    Task&lt;GoogleSignInAccount&gt; task = GoogleSignIn.getSignedInAccountFromIntent(result.getData());&#10;                    handleSignInResult(task);&#10;                } else {&#10;                    Toast.makeText(LoginActivity.this, &quot;Đăng nhập Google thất bại hoặc bị hủy.&quot;, Toast.LENGTH_SHORT).show();&#10;                }&#10;            });&#10;&#10;    private void handleSignInResult(Task&lt;GoogleSignInAccount&gt; completedTask) {&#10;        try {&#10;            GoogleSignInAccount account = completedTask.getResult(ApiException.class);&#10;            String idToken = account.getIdToken();&#10;&#10;            if (idToken != null) {&#10;                signInWithSupabaseGoogle(idToken);&#10;            } else {&#10;                Toast.makeText(this, &quot;Không thể lấy Google ID Token.&quot;, Toast.LENGTH_SHORT).show();&#10;            }&#10;        } catch (ApiException e) {&#10;            Log.e(TAG, &quot;Google Sign-In Error: &quot; + e.getMessage());&#10;            Toast.makeText(this, &quot;Đăng nhập Google thất bại: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show();&#10;        }&#10;    }&#10;&#10;&#10;    /**&#10;     * BƯỚC 1 (GOOGLE): Lấy Token&#10;     */&#10;    private void signInWithSupabaseGoogle(String idToken) {&#10;        String url = SupabaseClient.URL + &quot;/auth/v1/token?grant_type=id_token&quot;;&#10;        JsonObject json = new JsonObject();&#10;        json.addProperty(&quot;provider&quot;, &quot;google&quot;);&#10;        json.addProperty(&quot;id_token&quot;, idToken);&#10;&#10;        RequestBody body = RequestBody.create(gson.toJson(json), JSON);&#10;&#10;        Request request = new Request.Builder()&#10;                .url(url)&#10;                .post(body)&#10;                .addHeader(&quot;apikey&quot;, SupabaseClient.ANON_KEY)&#10;                .addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)&#10;                .build();&#10;&#10;        client.newCall(request).enqueue(new Callback() {&#10;            @Override public void onFailure(@NonNull Call call, @NonNull IOException e) {&#10;                runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi mạng: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show());&#10;            }&#10;&#10;            @Override public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {&#10;                if (response.body() == null) {&#10;                    runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi: Phản hồi từ server rỗng.&quot;, Toast.LENGTH_SHORT).show());&#10;                    return;&#10;                }&#10;                String resStr = response.body().string();&#10;                if (response.isSuccessful()) {&#10;                    JsonObject resJson = gson.fromJson(resStr, JsonObject.class);&#10;                    String accessToken = resJson.get(&quot;access_token&quot;).getAsString();&#10;                    String refreshToken = resJson.get(&quot;refresh_token&quot;).getAsString();&#10;                    JsonObject userObj = resJson.getAsJsonObject(&quot;user&quot;);&#10;                    String userId = userObj.get(&quot;id&quot;).getAsString();&#10;                    String email = userObj.get(&quot;email&quot;).getAsString();&#10;&#10;                    // === SỬA ĐỔI ===&#10;                    // (Không lưu và chuyển màn hình vội)&#10;                    // (Gọi Bước 2: Lấy hồ sơ)&#10;                    fetchUserProfileAndProceed(userId, email, accessToken, refreshToken);&#10;&#10;                } else {&#10;                    Log.e(TAG, &quot;Supabase Google login failed: &quot; + resStr);&#10;                    runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Đăng nhập Google thất bại.&quot;, Toast.LENGTH_LONG).show());&#10;                }&#10;            }&#10;        });&#10;    }&#10;&#10;    /**&#10;     * BƯỚC 1 (EMAIL): Lấy Token&#10;     */&#10;    private void loginWithEmail(String email, String password) {&#10;        String url = SupabaseClient.URL + &quot;/auth/v1/token?grant_type=password&quot;;&#10;        JsonObject json = new JsonObject();&#10;        json.addProperty(&quot;email&quot;, email);&#10;        json.addProperty(&quot;password&quot;, password);&#10;&#10;        RequestBody body = RequestBody.create(gson.toJson(json), JSON);&#10;&#10;        Request request = new Request.Builder()&#10;                .url(url)&#10;                .post(body)&#10;                .addHeader(&quot;apikey&quot;, SupabaseClient.ANON_KEY)&#10;                .addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)&#10;                .build();&#10;&#10;        client.newCall(request).enqueue(new Callback() {&#10;            @Override public void onFailure(@NonNull Call call, @NonNull IOException e) {&#10;                runOnUiThread(() -&gt;&#10;                        Toast.makeText(LoginActivity.this, &quot;Lỗi kết nối: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show());&#10;            }&#10;&#10;            @Override public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {&#10;                if (response.body() == null) {&#10;                    runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi: Phản hồi từ server rỗng.&quot;, Toast.LENGTH_SHORT).show());&#10;                    return;&#10;                }&#10;                String resStr = response.body().string();&#10;                if (response.isSuccessful()) {&#10;                    JsonObject resJson = gson.fromJson(resStr, JsonObject.class);&#10;                    String accessToken = resJson.get(&quot;access_token&quot;).getAsString();&#10;                    String refreshToken = resJson.get(&quot;refresh_token&quot;).getAsString();&#10;                    JsonObject userObj = resJson.getAsJsonObject(&quot;user&quot;);&#10;                    String userId = userObj.get(&quot;id&quot;).getAsString();&#10;&#10;                    // === SỬA ĐỔI ===&#10;                    // (Không lưu và chuyển màn hình vội)&#10;                    // (Gọi Bước 2: Lấy hồ sơ)&#10;                    fetchUserProfileAndProceed(userId, email, accessToken, refreshToken);&#10;&#10;                } else {&#10;                    runOnUiThread(() -&gt;&#10;                            Toast.makeText(LoginActivity.this, &quot;Sai email hoặc mật khẩu.&quot;, Toast.LENGTH_LONG).show());&#10;                }&#10;            }&#10;        });&#10;    }&#10;&#10;    /**&#10;     * ==========================================================&#10;     * HÀM MỚI (BƯỚC 2 &amp; 3): Lấy Hồ sơ và Lưu Session&#10;     * ==========================================================&#10;     */&#10;    private void fetchUserProfileAndProceed(String userId, String email, String accessToken, String refeshToken) {&#10;        // (API call: GET /rest/v1/users?user_id=eq.{userId}&amp;select=*)&#10;        String url = SupabaseClient.URL + &quot;/rest/v1/users?user_id=eq.&quot; + userId + &quot;&amp;select=*&quot;;&#10;&#10;        Request request = new Request.Builder()&#10;                .url(url)&#10;                .get()&#10;                .addHeader(&quot;apikey&quot;, SupabaseClient.ANON_KEY)&#10;                .addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken) // Dùng token MỚI&#10;                .build();&#10;&#10;        client.newCall(request).enqueue(new Callback() {&#10;            @Override&#10;            public void onFailure(@NonNull Call call, @NonNull IOException e) {&#10;                runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi tải hồ sơ: &quot; + e.getMessage(), Toast.LENGTH_SHORT).show());&#10;            }&#10;&#10;            @Override&#10;            public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {&#10;                if (response.body() == null) {&#10;                    runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi: Phản hồi từ server rỗng.&quot;, Toast.LENGTH_SHORT).show());&#10;                    return;&#10;                }&#10;                String resStr = response.body().string();&#10;                if (response.isSuccessful()) {&#10;                    // Kết quả là một mảng JSON: &quot;[{...}]&quot;&#10;                    JsonArray jsonArray = gson.fromJson(resStr, JsonArray.class);&#10;&#10;                    if (jsonArray.size() &gt; 0) {&#10;                        // Lấy hồ sơ (profile) đầu tiên&#10;                        JsonObject userProfile = jsonArray.get(0).getAsJsonObject();&#10;&#10;                        String fullName = userProfile.get(&quot;full_name&quot;).getAsString();&#10;                        String avatarUrl = userProfile.get(&quot;avatar_url&quot;).getAsString();&#10;&#10;                        // BƯỚC 3: LƯU TẤT CẢ VÀO SESSION&#10;                        prefManager.saveUserSession(&#10;                                userId,&#10;                                email,&#10;                                accessToken,&#10;                                refeshToken,&#10;                                fullName,&#10;                                avatarUrl&#10;                        );&#10;&#10;                        // Bây giờ mới chuyển màn hình&#10;                        runOnUiThread(() -&gt; {&#10;                            Toast.makeText(LoginActivity.this, &quot;Đăng nhập thành công!&quot;, Toast.LENGTH_SHORT).show();&#10;                            startActivity(new Intent(LoginActivity.this, MainActivity.class));&#10;                            finish();&#10;                        });&#10;                    } else {&#10;                        // (Lỗi này xảy ra nếu Trigger (bước 1) bị lỗi:&#10;                        //  đã tạo user (auth) nhưng chưa tạo profile (database))&#10;                        runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi: Không tìm thấy hồ sơ người dùng.&quot;, Toast.LENGTH_SHORT).show());&#10;                    }&#10;                } else {&#10;                    // Lỗi (ví dụ: 401 do RLS, 404, ...)&#10;                    runOnUiThread(() -&gt; Toast.makeText(LoginActivity.this, &quot;Lỗi tải hồ sơ: &quot; + resStr, Toast.LENGTH_LONG).show());&#10;                }&#10;            }&#10;        });&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>